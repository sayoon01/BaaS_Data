# GV60 데이터 배터리 성능 분석 실행 가이드

## 파이프라인 개요

이 파이프라인은 전기차 배터리의 충전 성능 데이터를 분석하여 배터리 수명(degradation)을 평가하는 전체 프로세스입니다.

### 전체 흐름
1. **통계 데이터 생성**: GV60 raw 데이터에서 충전 구간 추출 → 통계 데이터 생성
2. **참조값 계산**: 차량 타입별 표준값 설정 → 정규화 기준 마련
3. **Slope 계산**: 충전 속도 측정 및 보정 → 성능 지표 생성
4. **Degradation 계산**: 시간에 따른 성능 변화 측정 → 수명 평가
5. **월별 정규화**: 관측 기간 차이 보정 → 공정한 비교
6. **시각화**: 결과 비교 및 분석 → 인사이트 도출

### 핵심 개념

**정규화(Normalization)**
- 차량 모델, 충전 전류, 온도 등 다양한 요인을 보정하여 공정한 비교 가능
- slope_1 → slope_2 → slope_3 순으로 보정 단계가 높아질수록 더 정확

**Degradation Rate**
- 배터리 성능이 시간에 따라 얼마나 감소하는지 측정
- 양수: 성능 감소 (정상적인 노화)
- 음수: 성능 증가 (비정상, 측정 오차 가능)

**월별 정규화**
- 관측 기간이 다른 차량들을 공정하게 비교하기 위한 필수 단계
- 예: 6개월 동안 10% 감소 = 1.67%/월, 12개월 동안 10% 감소 = 0.83%/월

**충전 타입 구분 (GV60 데이터 특화)**
- `b_fast_charg_con_sts` 컬럼: 급속 충전 연결 상태
  - **True**: 급속(Fast) 충전 중
  - **False**: 급속 충전 아님 (아무것도 아님)
- `b_slow_charg_con_sts` 컬럼: 완속 충전 연결 상태
  - **True**: 완속(Slow) 충전 중
  - **False**: 완속 충전 아님 (아무것도 아님)
- 두 컬럼 모두 False인 경우: Unknown (충전 구간이지만 타입 불명)

---

## 사전 준비

### 1. 필요한 Python 패키지 설치

**Anaconda 사용 시** (권장):
```bash
# Anaconda 환경에서 python 사용 (python3가 아닌 python)
# pandas, numpy, matplotlib 설치
pip install pandas numpy matplotlib
# 또는
conda install pandas numpy matplotlib
```

**시스템 Python 사용 시**:
```bash
# pandas, numpy, matplotlib 설치
pip3 install pandas numpy matplotlib
```

**중요**: Anaconda 환경에서는 `python3` 대신 `python`을 사용하세요!

### 2. 작업 디렉토리 확인

현재 위치: `/Users/lyune/Desktop/KETI/BaaS`

GV60 데이터 위치: `GV60/` 디렉토리
BaAS_code 스크립트 위치: `BaAS_code/` 디렉토리

---

## 실행 순서

### 0단계: GV60 데이터 통계 데이터 생성 (get_statistics_gv60.py)

**목적**: GV60 raw 데이터에서 `kind='charging'`인 구간만 추출하여 BaAS_code 파이프라인에 필요한 통계 데이터 형식으로 변환

**처리 과정**:

1. **충전 구간 추출**
   - `kind` 컬럼에 'charging'이 포함된 연속된 구간을 찾아서 각각을 별도의 충전 구간으로 처리
   - 시간 차이가 5분 이상이면 새로운 구간으로 간주
   - 최소 2개 행 이상인 구간만 유효한 충전 구간으로 인정

2. **충전 타입 구분**
   - 각 충전 구간에서 `b_fast_charg_con_sts`와 `b_slow_charg_con_sts` 컬럼 값을 확인
   - **`b_fast_charg_con_sts`가 True** → **Fast (급속) 충전**
     - False면 급속 충전이 아님 (아무것도 아님)
   - **`b_slow_charg_con_sts`가 True** → **Slow (완속) 충전**
     - False면 완속 충전이 아님 (아무것도 아님)
   - 둘 다 False인 경우 → **Unknown** (충전 구간이지만 타입 불명)
   - 구간 내에서 더 많이 나타나는 타입으로 결정

3. **통계 데이터 생성**
   - 각 충전 구간별로 시작/종료 시간, SOC 변화, 평균 전류/전압, 평균 온도 등을 계산
   - BaAS_code 파이프라인에 필요한 형식으로 변환

**입력**: `GV60/*.csv` (raw 데이터 파일들)  
**출력**: `GV60/ev_statistics_fast_slow_stats.csv`

**실행 명령어**:

```bash
# 작업 디렉토리로 이동
cd /Users/lyune/Desktop/KETI/BaaS

# GV60 데이터 통계 데이터 생성
python BaAS_code/get_statistics_gv60.py --data-dir GV60 --output GV60/ev_statistics_fast_slow_stats.csv
```

**출력 확인**:
```bash
# Fast/Slow 충전 개수 확인
python << 'EOF'
import pandas as pd
df = pd.read_csv('GV60/ev_statistics_fast_slow_stats.csv')
print('=== 충전 타입별 개수 ===')
print(df['charge_type'].value_counts())
print(f'\n총 충전 구간: {len(df)}개')
print(f'고유 차량 수: {df["car_id"].nunique()}개')
EOF
```

**실제 결과 예시**:
- 총 충전 구간: 약 1,664개
- Slow 충전: 약 1,424개
- Fast 충전: 약 61개
- Unknown: 약 179개
- 고유 차량 수: 10개

---

### 1단계: 참조값 계산 (calculate_ref_values.py)

**입력**: `GV60/ev_statistics_fast_slow_stats.csv`  
**출력**: `GV60/ev_statistics_fast_slow_stats_v2.csv`

**목적**: 차량 타입별로 표준화된 참조값(reference value)을 계산하여, 이후 단계에서 충전 성능을 정규화하고 비교할 수 있는 기준점을 마련합니다.

**상세 설명**:

#### 처리 과정

1. **charge_type 컬럼 확인**
   - 0단계에서 이미 생성된 `charge_type` 컬럼 사용
   - 'fast', 'slow', 'unknown' 값이 포함되어 있음

2. **car_type별 참조값 계산**
   - 같은 차량 모델(GV60)끼리 그룹화
   - 이유: 차량 모델별로 배터리 용량, 충전 특성이 다르므로 모델별 기준값 필요
   
3. **참조값 종류**
   - **`fast_pack_current_ref`**: Fast 충전 시 해당 car_type의 평균 전류값
     - 용도: 실제 충전 전류를 표준 전류로 정규화하여 비교
   - **`fast_modul_temp_ref`**: Fast 충전 시 해당 car_type의 평균 모듈 온도
     - 용도: 온도 보정을 위한 기준 온도 (4개 모듈 온도의 평균)
   - **`slow_pack_current_ref`, `slow_modul_temp_ref`**: Slow 충전용 참조값
     - 이유: Fast와 Slow 충전은 전류와 온도 특성이 다르므로 별도 기준 필요

4. **각 행에 참조값 추가**
   - 모든 충전 기록에 해당 car_type의 참조값을 매핑
   - 이유: 이후 slope 계산 시 정규화에 사용

**스크립트 경로 수정**:

다음 명령어로 자동으로 경로를 수정합니다:

```bash
cd /Users/lyune/Desktop/KETI/BaaS

# calculate_ref_values.py 경로 수정
sed -i '' "s|/mnt/hdd_c_disk_8T/ev_statistics_fast_slow_stats.csv|GV60/ev_statistics_fast_slow_stats.csv|g" BaAS_code/calculate_ref_values.py
sed -i '' "s|/mnt/hdd_c_disk_8T/ev_statistics_fast_slow_stats_v2.csv|GV60/ev_statistics_fast_slow_stats_v2.csv|g" BaAS_code/calculate_ref_values.py
```

**실행 명령어**:

```bash
cd /Users/lyune/Desktop/KETI/BaaS
python BaAS_code/calculate_ref_values.py
```

**출력 확인**:
```bash
# 참조값 확인
python << 'EOF'
import pandas as pd
df = pd.read_csv('GV60/ev_statistics_fast_slow_stats_v2.csv')
print(f'총 행 수: {len(df)}개')
print(f'\n참조값:')
print(f'Fast 전류: {df["fast_pack_current_ref"].iloc[0]:.2f} A')
print(f'Fast 온도: {df["fast_modul_temp_ref"].iloc[0]:.2f} °C')
print(f'Slow 전류: {df["slow_pack_current_ref"].iloc[0]:.2f} A')
print(f'Slow 온도: {df["slow_modul_temp_ref"].iloc[0]:.2f} °C')
EOF
```

**실제 결과 예시**:
- 총 행 수: 1,664개
- Fast 전류: 약 -74.32 A
- Fast 온도: 약 31.35°C
- Slow 전류: 약 -5.83 A
- Slow 온도: 약 27.68°C

**추가된 컬럼**:
- `fast_pack_current_ref`: Fast 충전 시 해당 car_type의 평균 전류값
- `fast_modul_temp_ref`: Fast 충전 시 해당 car_type의 평균 모듈 온도
- `slow_pack_current_ref`: Slow 충전 시 해당 car_type의 평균 전류값
- `slow_modul_temp_ref`: Slow 충전 시 해당 car_type의 평균 모듈 온도

---

### 2단계: Slope 계산 (calculate_slopes.py)

**입력**: `GV60/ev_statistics_fast_slow_stats_v2.csv`  
**출력**: `GV60/ev_statistics_fast_slow_stats_v3.csv`

**목적**: 충전 속도(slope)를 계산하고, 전류와 온도 보정을 통해 표준화된 충전 성능 지표를 생성합니다.

**상세 설명**:

#### 처리 과정

1. **조건 필터링**
   - `start_soc >= 20`: 시작 SOC가 20% 이상인 충전만 선택
     - 이유: SOC가 너무 낮으면 충전 특성이 달라질 수 있음
   - `soc_quan >= 15`: 충전량이 15% 이상인 충전만 선택
     - 이유: 충전량이 너무 적으면 측정 오차가 큼
   - `duration >= 180`: 충전 시간이 180초(3분) 이상인 충전만 선택
     - 이유: 너무 짧은 충전은 신뢰할 수 없음

2. **Fast 충전 Slope 계산 (3단계 보정)**
   
   **`fast_slope_1`**: 기본 충전 속도
   - 공식: `soc_quan / duration_hour`
   - 의미: 시간당 충전된 SOC 비율 (%/hour)
   - 용도: 가장 기본적인 충전 속도 지표
   
   **`fast_slope_2`**: 전류 보정된 충전 속도
   - 공식: `fast_slope_1 * fast_pack_current_ref / b_pack_current_avg`
   - 의미: 실제 전류가 표준 전류와 다를 때 보정
   - 이유: 전류가 낮으면 충전 속도가 느려지므로, 표준 전류 기준으로 정규화
   - 예: 표준 전류가 100A인데 실제 80A면, slope를 100/80 = 1.25배로 보정
   
   **`fast_slope_3`**: 전류 + 온도 보정된 충전 속도
   - 공식: `fast_slope_2 * (1 - 0.01 * (평균모듈온도 - fast_modul_temp_ref))`
   - 의미: 온도가 기준보다 높으면 충전 효율이 떨어지므로 보정
   - 이유: 배터리 온도가 높을수록 충전 효율이 감소 (약 1도당 1% 감소 가정)
   - 예: 기준 온도 25도, 실제 30도면 5도 차이 → 5% 감소 보정

3. **Slow 충전 Slope 계산**
   - Fast와 동일한 3단계 보정 적용
   - 단, Slow 충전용 참조값(`slow_pack_current_ref`, `slow_modul_temp_ref`) 사용
   - 이유: Slow 충전은 전류와 온도 특성이 Fast와 다름

#### 결과
- 각 충전 기록마다 3단계 보정된 slope 값 저장
- 보정 단계가 높을수록 더 정확한 성능 지표 (slope_3가 가장 정확)

**스크립트 경로 수정**:

```bash
# 스크립트 파일 열기
nano BaAS_code/calculate_slopes.py
```

**수정할 내용**:
- 6번째 줄: `df = pd.read_csv('/mnt/hdd_c_disk_8T/ev_statistics_fast_slow_stats_v2.csv')`
  → `df = pd.read_csv('GV60/ev_statistics_fast_slow_stats_v2.csv')`
- 101번째 줄: `filtered_df.to_csv('/mnt/hdd_c_disk_8T/ev_statistics_fast_slow_stats_v3.csv', index=False)`
  → `filtered_df.to_csv('GV60/ev_statistics_fast_slow_stats_v3.csv', index=False)`

**빠른 경로 수정 방법**:

```bash
cd /Users/lyune/Desktop/KETI/BaaS

# calculate_slopes.py 경로 수정
sed -i '' "s|/mnt/hdd_c_disk_8T/ev_statistics_fast_slow_stats_v2.csv|GV60/ev_statistics_fast_slow_stats_v2.csv|g" BaAS_code/calculate_slopes.py
sed -i '' "s|/mnt/hdd_c_disk_8T/ev_statistics_fast_slow_stats_v3.csv|GV60/ev_statistics_fast_slow_stats_v3.csv|g" BaAS_code/calculate_slopes.py
```

**실행 명령어**:

```bash
cd /Users/lyune/Desktop/KETI/BaaS
python BaAS_code/calculate_slopes.py
```

**출력 확인**:
```bash
# 필터링 후 통계 확인
python << 'EOF'
import pandas as pd
df = pd.read_csv('GV60/ev_statistics_fast_slow_stats_v3.csv')
print('=== 필터링 후 통계 (v3) ===')
print(f'총 행 수: {len(df)}개')
print(f'\n=== 충전 타입별 개수 ===')
print(df['charge_type'].value_counts())
print(f'\n=== Fast/Slow 상세 ===')
print(f'Fast 충전: {(df["charge_type"] == "fast").sum()}개')
print(f'Slow 충전: {(df["charge_type"] == "slow").sum()}개')
EOF
```

**실제 결과 예시**:
- 필터링 후 행 수: 약 108개 (원본 1,664개에서 필터링)
- Fast 충전: 약 19개
- Slow 충전: 약 89개

**필터링 조건**:
- `start_soc >= 20`: 시작 SOC가 20% 이상
- `soc_quan >= 15`: 충전량이 15% 이상
- `duration >= 180`: 충전 시간이 180초(3분) 이상

**추가된 컬럼**:
- `fast_slope_1`: 기본 충전 속도 (%/hour)
- `fast_slope_2`: 전류 보정 충전 속도
- `fast_slope_3`: 전류+온도 보정 충전 속도 (가장 정확)
- `slow_slope_1`, `slow_slope_2`, `slow_slope_3`: Slow 충전용 동일한 지표

---

### 3단계: Degradation Rate 계산 (calculate_degradation.py)

**입력**: `GV60/ev_statistics_fast_slow_stats_v3.csv`  
**출력**: `GV60/ev_statistics_fast_slow_stats_v4.csv`

**목적**: 각 차량의 배터리 성능 저하(degradation) 정도를 시간에 따라 측정합니다. 초기 충전 성능과 최근 충전 성능을 비교하여 배터리 수명을 평가합니다.

**상세 설명**:

#### 처리 과정

1. **car_id별 그룹화**
   - 같은 차량의 모든 충전 기록을 하나로 묶음
   - 이유: 차량별로 개별적인 degradation 추적 필요

2. **Fast 충전 Degradation 계산**
   
   **시간 정렬**
   - `start_time` 기준으로 오름차순 정렬
   - 가장 과거 행: 첫 충전 기록 (초기 성능)
   - 가장 최신 행: 마지막 충전 기록 (현재 성능)
   
   **Degradation Rate 계산**
   - 공식: `(과거값 - 최신값) / 과거값 * 100`
   - 의미: 초기 대비 현재 성능이 몇 % 감소했는지
   - 예: slope_1이 30에서 27로 감소 → (30-27)/30 * 100 = 10% 감소
   - 양수: 성능 감소 (정상적인 degradation)
   - 음수: 성능 증가 (비정상, 측정 오차 가능)
   
   **3가지 Slope에 대해 각각 계산**
   - `fast_degradation_rate_1`: 기본 slope 기준
   - `fast_degradation_rate_2`: 전류 보정 slope 기준
   - `fast_degradation_rate_3`: 전류+온도 보정 slope 기준 (가장 정확)
   
   **날짜 정보 저장**
   - `first_fast_charging_date`: 첫 Fast 충전 날짜
   - `last_fast_charging_date`: 마지막 Fast 충전 날짜
   - 용도: 이후 월별 degradation rate 계산에 사용

3. **Slow 충전 Degradation 계산**
   - Fast와 동일한 방식으로 처리
   - Slow 충전만 따로 추적
   - 이유: Fast와 Slow 충전의 degradation 패턴이 다를 수 있음

4. **결과 구조**
   - 각 `car_id`당 한 행으로 집계
   - 이유: 차량별 전체 기간의 degradation을 요약
   - Fast와 Slow가 모두 있는 차량은 두 값 모두 저장
   - 하나만 있는 차량은 해당 값만 저장

**스크립트 경로 수정**:

```bash
# 스크립트 파일 열기
nano BaAS_code/calculate_degradation.py
```

**수정할 내용**:
- 7번째 줄: `df = pd.read_csv('/mnt/hdd_c_disk_8T/ev_statistics_fast_slow_stats_v3.csv')`
  → `df = pd.read_csv('GV60/ev_statistics_fast_slow_stats_v3.csv')`
- 107번째 줄: `result_df.to_csv('/mnt/hdd_c_disk_8T/ev_statistics_fast_slow_stats_v4.csv', index=False)`
  → `result_df.to_csv('GV60/ev_statistics_fast_slow_stats_v4.csv', index=False)`

**빠른 경로 수정 방법**:

```bash
cd /Users/lyune/Desktop/KETI/BaaS

# calculate_degradation.py 경로 수정
sed -i '' "s|/mnt/hdd_c_disk_8T/ev_statistics_fast_slow_stats_v3.csv|GV60/ev_statistics_fast_slow_stats_v3.csv|g" BaAS_code/calculate_degradation.py
sed -i '' "s|/mnt/hdd_c_disk_8T/ev_statistics_fast_slow_stats_v4.csv|GV60/ev_statistics_fast_slow_stats_v4.csv|g" BaAS_code/calculate_degradation.py
```

**실행 명령어**:

```bash
cd /Users/lyune/Desktop/KETI/BaaS
python BaAS_code/calculate_degradation.py
```

**출력 확인**:
```bash
# v4 파일 확인
python << 'EOF'
import pandas as pd
df = pd.read_csv('GV60/ev_statistics_fast_slow_stats_v4.csv')
print(f'총 행 수: {len(df)}개 (car_id별 집계)')
print(f'Fast: {df["first_fast_charging_date"].notna().sum()}개, Slow: {df["first_slow_charging_date"].notna().sum()}개')
print(f'\nFast degradation_rate_3 평균: {df["fast_degradation_rate_3"].mean():.4f}%')
print(f'Slow degradation_rate_3 평균: {df["slow_degradation_rate_3"].mean():.4f}%')
EOF
```

**실제 결과 예시**:
- 총 행 수: 10개 (car_id별 집계)
- Fast 충전 데이터: 7개 차량
- Slow 충전 데이터: 10개 차량
- Fast degradation_rate_3 평균: 약 -7.28%
- Slow degradation_rate_3 평균: 약 -1.57%

**추가된 컬럼**:
- `first_fast_charging_date`, `last_fast_charging_date`: Fast 충전 날짜
- `fast_degradation_rate_1`, `fast_degradation_rate_2`, `fast_degradation_rate_3`: Fast 충전 degradation rate (%)
- `first_slow_charging_date`, `last_slow_charging_date`: Slow 충전 날짜
- `slow_degradation_rate_1`, `slow_degradation_rate_2`, `slow_degradation_rate_3`: Slow 충전 degradation rate (%)

**참고**: v4는 각 car_id당 한 행으로 집계됨 (차량별 요약)

---

### 4단계: 월별 Degradation Rate 계산 (calculate_monthly_degradation.py)

**입력**: `GV60/ev_statistics_fast_slow_stats_v4.csv`  
**출력**: 
- `GV60/ev_statistics_fast_slow_stats_v5.csv` (전체 데이터)
- `GV60/ev_statistics_fast_slow_stats_v6.csv` (3개월 이상만 필터링)

**목적**: 전체 기간의 degradation rate를 월별로 정규화하여, 관측 기간이 다른 차량들 간의 성능 저하를 공정하게 비교할 수 있도록 합니다.

**상세 설명**:

#### 처리 과정

1. **날짜 차이 계산**
   - `last_charging_date - first_charging_date`를 일 단위로 계산
   - 일 단위를 30으로 나누어 개월 수로 변환
   - 예: 270일 차이 → 9개월

2. **월별 Degradation Rate 계산**
   
   **공식**: `degradation_rate_per_month = degradation_rate / (날짜차이 개월수)`
   
   **이유**:
   - 6개월 동안 10% 감소한 차량과 12개월 동안 10% 감소한 차량은 degradation 속도가 다름
   - 월별로 정규화하면: 6개월 차량은 10/6 = 1.67%/월, 12개월 차량은 10/12 = 0.83%/월
   - 이렇게 하면 차량 간 degradation 속도를 공정하게 비교 가능
   
   **6개 지표 모두 계산**:
   - `fast_degradation_rate_1_per_month`
   - `fast_degradation_rate_2_per_month`
   - `fast_degradation_rate_3_per_month`
   - `slow_degradation_rate_1_per_month`
   - `slow_degradation_rate_2_per_month`
   - `slow_degradation_rate_3_per_month`

3. **파일 분리**

   **v5 (전체 데이터)**
   - 모든 차량의 월별 degradation rate 저장
   - 관측 기간이 짧은 차량도 포함
   - 용도: 전체 데이터 분석
   
   **v6 (3개월 이상 필터링)**
   - Fast 또는 Slow 중 하나라도 3개월 이상인 차량만 선택
   - 이유: 관측 기간이 너무 짧으면 degradation 측정이 부정확할 수 있음
   - 3개월 이상 데이터만 사용하면 더 신뢰할 수 있는 분석 가능
   - 용도: 신뢰도 높은 데이터만으로 분석

4. **통계 출력**
   - 전체 기간 통계: v5 데이터 기준
   - 3개월 이상 통계: v6 데이터 기준
   - 각 지표별 평균, 표준편차, 샘플 수 출력
   - 용도: 두 그룹 간 degradation 패턴 비교

**스크립트 경로 수정**:

```bash
# 스크립트 파일 열기
nano BaAS_code/calculate_monthly_degradation.py
```

**수정할 내용**:
- 7번째 줄: `df = pd.read_csv('/mnt/hdd_c_disk_8T/ev_statistics_fast_slow_stats_v4.csv')`
  → `df = pd.read_csv('GV60/ev_statistics_fast_slow_stats_v4.csv')`
- 87번째 줄: `df.to_csv('/mnt/hdd_c_disk_8T/ev_statistics_fast_slow_stats_v5.csv', index=False)`
  → `df.to_csv('GV60/ev_statistics_fast_slow_stats_v5.csv', index=False)`
- 110번째 줄: `filtered_df.to_csv('/mnt/hdd_c_disk_8T/ev_statistics_fast_slow_stats_v6.csv', index=False)`
  → `filtered_df.to_csv('GV60/ev_statistics_fast_slow_stats_v6.csv', index=False)`

**빠른 경로 수정 방법**:

```bash
cd /Users/lyune/Desktop/KETI/BaaS

# calculate_monthly_degradation.py 경로 수정
sed -i '' "s|/mnt/hdd_c_disk_8T/ev_statistics_fast_slow_stats_v4.csv|GV60/ev_statistics_fast_slow_stats_v4.csv|g" BaAS_code/calculate_monthly_degradation.py
sed -i '' "s|/mnt/hdd_c_disk_8T/ev_statistics_fast_slow_stats_v5.csv|GV60/ev_statistics_fast_slow_stats_v5.csv|g" BaAS_code/calculate_monthly_degradation.py
sed -i '' "s|/mnt/hdd_c_disk_8T/ev_statistics_fast_slow_stats_v6.csv|GV60/ev_statistics_fast_slow_stats_v6.csv|g" BaAS_code/calculate_monthly_degradation.py
```

**실행 명령어**:

```bash
cd /Users/lyune/Desktop/KETI/BaaS
python BaAS_code/calculate_monthly_degradation.py
```

**출력 확인**:
```bash
# v5 vs v6 비교 확인
python << 'EOF'
import pandas as pd
v5 = pd.read_csv('GV60/ev_statistics_fast_slow_stats_v5.csv')
v6 = pd.read_csv('GV60/ev_statistics_fast_slow_stats_v6.csv')
print('v5: Fast={:.4f}%/월 (n={}), Slow={:.4f}%/월 (n={})'.format(
    v5['fast_degradation_rate_3_per_month'].mean(), 
    v5['fast_degradation_rate_3_per_month'].notna().sum(),
    v5['slow_degradation_rate_3_per_month'].mean(), 
    v5['slow_degradation_rate_3_per_month'].notna().sum()
))
print('v6: Fast={:.4f}%/월 (n={}), Slow={:.4f}%/월 (n={})'.format(
    v6['fast_degradation_rate_3_per_month'].mean(), 
    v6['fast_degradation_rate_3_per_month'].notna().sum(),
    v6['slow_degradation_rate_3_per_month'].mean(), 
    v6['slow_degradation_rate_3_per_month'].notna().sum()
))
EOF
```

**실제 결과 예시**:
- v5 (전체): Fast 약 -9.69%/월 (n=3), Slow 약 -0.36%/월 (n=9)
- v6 (3개월 이상): Fast 약 -13.86%/월 (n=2), Slow 약 -1.28%/월 (n=6)

**추가된 컬럼**:
- `fast_degradation_rate_1_per_month`: Fast 기본 slope 기준 월평균 degradation rate (%/month)
- `fast_degradation_rate_2_per_month`: Fast 전류 보정 기준
- `fast_degradation_rate_3_per_month`: Fast 전류+온도 보정 기준 (가장 정확)
- `slow_degradation_rate_1_per_month`, `slow_degradation_rate_2_per_month`, `slow_degradation_rate_3_per_month`: Slow 충전용 동일한 지표

**v5 vs v6 차이**:
- **v5**: 모든 차량 포함 (관측 기간 무관)
- **v6**: Fast 또는 Slow 중 하나라도 3개월 이상인 차량만 (신뢰도 높은 데이터)

---

### 5단계: 시각화 (plot_degradation_deviation.py)

**입력**: 
- `GV60/ev_statistics_fast_slow_stats_v5.csv`
- `GV60/ev_statistics_fast_slow_stats_v6.csv`

**출력**: `GV60/degradation_rate_comparison.png`

**목적**: 전체 데이터(v5)와 3개월 이상 데이터(v6)의 degradation rate 분포를 시각적으로 비교하여, 필터링이 분석 결과에 미치는 영향을 확인합니다.

**상세 설명**:

#### 처리 과정

1. **데이터 읽기**
   - v5: 전체 차량 데이터 (관측 기간 무관)
   - v6: 3개월 이상 관측된 차량만 (신뢰도 높은 데이터)

2. **6개 지표 시각화**
   
   **지표 종류**:
   - `fast_degradation_rate_1_per_month`: Fast 기본 slope 기준
   - `fast_degradation_rate_2_per_month`: Fast 전류 보정 slope 기준
   - `fast_degradation_rate_3_per_month`: Fast 전류+온도 보정 slope 기준 (가장 정확)
   - `slow_degradation_rate_1_per_month`: Slow 기본 slope 기준
   - `slow_degradation_rate_2_per_month`: Slow 전류 보정 slope 기준
   - `slow_degradation_rate_3_per_month`: Slow 전류+온도 보정 slope 기준 (가장 정확)
   
   **박스플롯 구성**:
   - 2x3 서브플롯: 6개 지표를 각각 한 그래프에 표시
   - 각 그래프에 v5와 v6를 나란히 비교
   - 박스플롯 요소:
     - 중앙선: 중앙값 (median)
     - 박스: 25% ~ 75% 사분위수 (IQR)
     - 수염: 이상치를 제외한 범위
     - 점: 이상치 (outliers)
     - 평균선: 평균값 표시

3. **통계 정보 표시**
   - 각 그래프 제목에 다음 정보 포함:
     - v5: 평균, 표준편차, 샘플 수
     - v6: 평균, 표준편차, 샘플 수
   - 용도: 수치적 비교 가능

4. **통계 요약 테이블**
   - 콘솔에 모든 지표의 통계 요약 출력
   - 형식: 지표명, v5 평균/표준편차/n, v6 평균/표준편차/n
   - 용도: 정확한 수치 비교 및 보고서 작성

#### 분석 관점

**v5 vs v6 비교의 의미**:
- **v5 (전체)**: 모든 차량 포함, 샘플 수 많음, 하지만 관측 기간 짧은 차량 포함
- **v6 (3개월 이상)**: 신뢰도 높은 데이터만, 샘플 수 적음, 하지만 더 정확한 측정

**기대되는 차이**:
- v6가 더 안정적인 분포를 보일 수 있음 (이상치 제거 효과)
- v6의 평균이 v5와 다를 수 있음 (관측 기간이 긴 차량의 특성 반영)
- v6의 표준편차가 더 작을 수 있음 (신뢰도 높은 데이터만 포함)

**스크립트 경로 수정**:

```bash
# 스크립트 파일 열기
nano BaAS_code/plot_degradation_deviation.py
```

**수정할 내용**:
- 9번째 줄: `df_v5 = pd.read_csv('/mnt/hdd_c_disk_8T/ev_statistics_fast_slow_stats_v5.csv')`
  → `df_v5 = pd.read_csv('GV60/ev_statistics_fast_slow_stats_v5.csv')`
- 10번째 줄: `df_v6 = pd.read_csv('/mnt/hdd_c_disk_8T/ev_statistics_fast_slow_stats_v6.csv')`
  → `df_v6 = pd.read_csv('GV60/ev_statistics_fast_slow_stats_v6.csv')`
- 81번째 줄: `output_file = '/mnt/hdd_c_disk_8T/degradation_rate_comparison.png'`
  → `output_file = 'GV60/degradation_rate_comparison.png'`

**빠른 경로 수정 방법**:

```bash
cd /Users/lyune/Desktop/KETI/BaaS

# plot_degradation_deviation.py 경로 수정
sed -i '' "s|/mnt/hdd_c_disk_8T/ev_statistics_fast_slow_stats_v5.csv|GV60/ev_statistics_fast_slow_stats_v5.csv|g" BaAS_code/plot_degradation_deviation.py
sed -i '' "s|/mnt/hdd_c_disk_8T/ev_statistics_fast_slow_stats_v6.csv|GV60/ev_statistics_fast_slow_stats_v6.csv|g" BaAS_code/plot_degradation_deviation.py
sed -i '' "s|/mnt/hdd_c_disk_8T/degradation_rate_comparison.png|GV60/degradation_rate_comparison.png|g" BaAS_code/plot_degradation_deviation.py
```

**실행 명령어**:

```bash
cd /Users/lyune/Desktop/KETI/BaaS
python BaAS_code/plot_degradation_deviation.py
```

**출력 확인**:
```bash
# 그래프 파일 확인
ls -lh GV60/degradation_rate_comparison.png

# macOS에서 그래프 열기
open GV60/degradation_rate_comparison.png
```

**실제 결과 예시**:
- 그래프 파일 생성: `GV60/degradation_rate_comparison.png` (약 360KB)
- 콘솔에 통계 요약 테이블 출력됨
- 6개 지표별 박스플롯 생성

**참고**: 
- 한글 폰트 문제: 스크립트가 자동으로 AppleGothic 폰트로 설정되어 있음
- 그래프가 정상적으로 생성되었는지 확인

**그래프 내용**:
- 6개 지표별 박스플롯 (v5 vs v6 비교)
- 각 지표별 평균, 표준편차, 샘플 수 표시

---

## 전체 실행 순서 요약

```bash
# 1. 패키지 설치
pip install pandas numpy matplotlib

# 2. 작업 디렉토리로 이동
cd /Users/lyune/Desktop/KETI/BaaS

# 3. GV60 데이터 통계 데이터 생성
python BaAS_code/get_statistics_gv60.py --data-dir GV60 --output GV60/ev_statistics_fast_slow_stats.csv

# 4. 모든 스크립트의 경로를 일괄 수정 (아래 명령어 실행)
cd /Users/lyune/Desktop/KETI/BaaS

# calculate_ref_values.py
sed -i '' "s|/mnt/hdd_c_disk_8T/ev_statistics_fast_slow_stats.csv|GV60/ev_statistics_fast_slow_stats.csv|g" BaAS_code/calculate_ref_values.py
sed -i '' "s|/mnt/hdd_c_disk_8T/ev_statistics_fast_slow_stats_v2.csv|GV60/ev_statistics_fast_slow_stats_v2.csv|g" BaAS_code/calculate_ref_values.py

# calculate_slopes.py
sed -i '' "s|/mnt/hdd_c_disk_8T/ev_statistics_fast_slow_stats_v2.csv|GV60/ev_statistics_fast_slow_stats_v2.csv|g" BaAS_code/calculate_slopes.py
sed -i '' "s|/mnt/hdd_c_disk_8T/ev_statistics_fast_slow_stats_v3.csv|GV60/ev_statistics_fast_slow_stats_v3.csv|g" BaAS_code/calculate_slopes.py

# calculate_degradation.py
sed -i '' "s|/mnt/hdd_c_disk_8T/ev_statistics_fast_slow_stats_v3.csv|GV60/ev_statistics_fast_slow_stats_v3.csv|g" BaAS_code/calculate_degradation.py
sed -i '' "s|/mnt/hdd_c_disk_8T/ev_statistics_fast_slow_stats_v4.csv|GV60/ev_statistics_fast_slow_stats_v4.csv|g" BaAS_code/calculate_degradation.py

# calculate_monthly_degradation.py
sed -i '' "s|/mnt/hdd_c_disk_8T/ev_statistics_fast_slow_stats_v4.csv|GV60/ev_statistics_fast_slow_stats_v4.csv|g" BaAS_code/calculate_monthly_degradation.py
sed -i '' "s|/mnt/hdd_c_disk_8T/ev_statistics_fast_slow_stats_v5.csv|GV60/ev_statistics_fast_slow_stats_v5.csv|g" BaAS_code/calculate_monthly_degradation.py
sed -i '' "s|/mnt/hdd_c_disk_8T/ev_statistics_fast_slow_stats_v6.csv|GV60/ev_statistics_fast_slow_stats_v6.csv|g" BaAS_code/calculate_monthly_degradation.py

# plot_degradation_deviation.py
sed -i '' "s|/mnt/hdd_c_disk_8T/ev_statistics_fast_slow_stats_v5.csv|GV60/ev_statistics_fast_slow_stats_v5.csv|g" BaAS_code/plot_degradation_deviation.py
sed -i '' "s|/mnt/hdd_c_disk_8T/ev_statistics_fast_slow_stats_v6.csv|GV60/ev_statistics_fast_slow_stats_v6.csv|g" BaAS_code/plot_degradation_deviation.py
sed -i '' "s|/mnt/hdd_c_disk_8T/degradation_rate_comparison.png|GV60/degradation_rate_comparison.png|g" BaAS_code/plot_degradation_deviation.py

# 5. 순서대로 실행 (Anaconda 환경에서는 python 사용)
python BaAS_code/calculate_ref_values.py
python BaAS_code/calculate_slopes.py
python BaAS_code/calculate_degradation.py
python BaAS_code/calculate_monthly_degradation.py
python BaAS_code/plot_degradation_deviation.py
```

**실제 실행 결과 요약**:
- **0단계**: 1,664개 충전 구간 추출 (Fast: 61개, Slow: 1,424개, Unknown: 179개, 차량 수: 10개)
- **1단계**: 참조값 계산 완료 (Fast 전류: -74.32A, Fast 온도: 31.35°C, Slow 전류: -5.83A, Slow 온도: 27.68°C)
- **2단계**: 필터링 후 108개 구간 (Fast: 19개, Slow: 89개)
- **3단계**: 10개 차량별 degradation rate 계산 (Fast: 7개 차량, Slow: 10개 차량)
  - Fast degradation_rate_3 평균: -7.28%
  - Slow degradation_rate_3 평균: -1.57%
- **4단계**: v5 (10개 차량), v6 (6개 차량, 3개월 이상) 생성
  - v5: Fast -9.69%/월 (n=3), Slow -0.36%/월 (n=9)
  - v6: Fast -13.86%/월 (n=2), Slow -1.28%/월 (n=6)
- **5단계**: 그래프 생성 완료 (`degradation_rate_comparison.png`, 약 360KB)

**주의**: 
- macOS에서는 `sed -i ''` 형식을 사용하고, Linux에서는 `sed -i`만 사용합니다.
- 경로 수정은 이미 완료되었으므로 다시 수정할 필요 없습니다.
- 스크립트 실행 시 `python` 명령어 사용 (Anaconda 환경)

---

## 파일 구조

```
GV60/
  ├── M2211120390.csv          # 원본 raw 데이터
  ├── M2211121225.csv
  ├── ... (기타 CSV 파일들)
  ├── ev_statistics_fast_slow_stats.csv          # 0단계: 통계 데이터 생성
      ↓ calculate_ref_values.py
  ├── ev_statistics_fast_slow_stats_v2.csv        # 1단계: 참조값 추가
      ↓ calculate_slopes.py
  ├── ev_statistics_fast_slow_stats_v3.csv        # 2단계: Slope 계산 (필터링됨)
      ↓ calculate_degradation.py
  ├── ev_statistics_fast_slow_stats_v4.csv        # 3단계: Degradation rate (car_id별 집계)
      ↓ calculate_monthly_degradation.py
  ├── ev_statistics_fast_slow_stats_v5.csv        # 4단계: 월별 Degradation rate (전체)
  ├── ev_statistics_fast_slow_stats_v6.csv        # 4단계: 월별 Degradation rate (3개월 이상)
      ↓ plot_degradation_deviation.py
  └── degradation_rate_comparison.png             # 5단계: 비교 그래프
```

---

## 주요 컬럼 설명

### v1 (통계 데이터) 컬럼

- `car_id`: 차량 ID
- `charge_type`: 충전 타입 ('fast', 'slow', 'unknown')
  - **`b_fast_charg_con_sts`가 True** → **'fast' (급속 충전)**
    - False면 급속 충전이 아님 (아무것도 아님)
  - **`b_slow_charg_con_sts`가 True** → **'slow' (완속 충전)**
    - False면 완속 충전이 아님 (아무것도 아님)
  - 둘 다 False → 'unknown' (충전 구간이지만 타입 불명)
- `start_soc`, `end_soc`, `soc_quan`: SOC 정보
- `start_time`, `end_time`, `duration`, `duration_hour`: 시간 정보
- `b_modul_1_temp_avg` ~ `b_modul_4_temp_avg`: 평균 모듈 온도
- `b_pack_current_avg`, `b_pack_volt_avg`: 평균 전류/전압
- `car_type`: 차량 타입 (GV60)

### v2 추가 컬럼 (참조값)

- `fast_pack_current_ref`: Fast 충전 시 해당 car_type의 평균 전류값
- `fast_modul_temp_ref`: Fast 충전 시 해당 car_type의 평균 모듈 온도
- `slow_pack_current_ref`, `slow_modul_temp_ref`: Slow 충전용 참조값

### v3 추가 컬럼 (Slope - 충전 속도)

- `fast_slope_1`: 기본 충전 속도 (%/hour)
- `fast_slope_2`: 전류 보정 충전 속도
- `fast_slope_3`: 전류+온도 보정 충전 속도 (가장 정확)
- `slow_slope_1`, `slow_slope_2`, `slow_slope_3`: Slow 충전용 동일한 지표

### v4 추가 컬럼 (Degradation Rate - car_id별 집계)

- `first_fast_charging_date`, `last_fast_charging_date`: Fast 충전 날짜
- `fast_degradation_rate_1`, `fast_degradation_rate_2`, `fast_degradation_rate_3`: Fast 충전 degradation rate (%)
- `first_slow_charging_date`, `last_slow_charging_date`: Slow 충전 날짜
- `slow_degradation_rate_1`, `slow_degradation_rate_2`, `slow_degradation_rate_3`: Slow 충전 degradation rate (%)

### v5/v6 추가 컬럼 (월별 Degradation Rate)

- `fast_degradation_rate_1_per_month`: Fast 기본 slope 기준 월평균 degradation rate (%/month)
- `fast_degradation_rate_2_per_month`: Fast 전류 보정 기준
- `fast_degradation_rate_3_per_month`: Fast 전류+온도 보정 기준 (가장 정확)
- `slow_degradation_rate_1_per_month`, `slow_degradation_rate_2_per_month`, `slow_degradation_rate_3_per_month`: Slow 충전용 동일한 지표

---

## 문제 해결

### 오류: 파일을 찾을 수 없음
→ 스크립트 내 경로를 GV60 디렉토리로 수정했는지 확인

### 오류: car_type 컬럼이 없음
→ `get_statistics_gv60.py`에서 자동으로 'GV60'으로 설정되므로 문제 없음

### 오류: charge_type이 없음
→ `get_statistics_gv60.py`에서 `b_fast_charg_con_sts`와 `b_slow_charg_con_sts`로 자동 생성됨

### 오류: ModuleNotFoundError: No module named 'pandas'
→ Anaconda 환경에서는 `python3` 대신 `python`을 사용하세요

### 오류: permission denied
→ Python 스크립트는 `python 스크립트명.py` 형식으로 실행해야 합니다
→ 직접 실행하려면 `chmod +x 스크립트명.py`로 실행 권한 부여 필요

### PNG 그래프 한글 깨짐
→ 스크립트가 자동으로 AppleGothic 폰트로 설정되어 있음
→ 그래프는 정상적으로 생성되지만, 한글이 깨질 수 있음 (macOS 환경)

### Unknown 충전 구간이 많음
→ `b_fast_charg_con_sts`와 `b_slow_charg_con_sts`가 둘 다 False인 경우입니다. 
   이는 정상적인 현상이며, 분석 시 제외하거나 별도로 처리할 수 있습니다.

---

## 참고 사항

- 모든 스크립트는 Anaconda 환경에서 `python` 명령어로 실행합니다
- 각 단계는 순서대로 실행해야 합니다
- 중간 파일(v2, v3, v4, v5, v6)은 다음 단계의 입력으로 사용되므로 삭제하지 마세요
- 경로 수정은 sed 명령어로 일괄 처리하거나, 각 스크립트를 직접 수정할 수 있습니다
